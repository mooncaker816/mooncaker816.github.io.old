
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>The Go Programming Language Ex（10） | Mooncaker816</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Ex 8.6Add depth-limiting to the concurrent crawler. That is, if the user sets -depth=3, then only URLs reachable by at most three links will be fetched.">
<meta name="keywords" content="The Go Programming Language Ex,Go goroutine,Go breadth first crawler,Go select,Go chat room">
<meta property="og:type" content="article">
<meta property="og:title" content="The Go Programming Language Ex（10）">
<meta property="og:url" content="https://mooncaker816.github.io/2018/01/03/The-Go-Programming-Language-Ex (10)/index.html">
<meta property="og:site_name" content="Mooncaker816">
<meta property="og:description" content="Ex 8.6Add depth-limiting to the concurrent crawler. That is, if the user sets -depth=3, then only URLs reachable by at most three links will be fetched.">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-01-04T01:14:37.125Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Go Programming Language Ex（10）">
<meta name="twitter:description" content="Ex 8.6Add depth-limiting to the concurrent crawler. That is, if the user sets -depth=3, then only URLs reachable by at most three links will be fetched.">
  
    <link rel="alternative" href="/atom.xml" title="Mooncaker816" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Mooncaker816</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">主页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="mooncaker816.github.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-The-Go-Programming-Language-Ex (10)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/03/The-Go-Programming-Language-Ex (10)/" class="article-date">
  <time datetime="2018-01-02T16:00:00.000Z" itemprop="datePublished">2018-01-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      The Go Programming Language Ex（10）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Ex-8-6"><a href="#Ex-8-6" class="headerlink" title="Ex 8.6"></a>Ex 8.6</h3><p>Add depth-limiting to the concurrent crawler. That is, if the user sets -depth=3, then only URLs reachable by at most three links will be fetched.</p>
<a id="more"></a>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright © 2016 Alan A. A. Donovan &amp; Brian W. Kernighan.</span></span><br><span class="line"><span class="comment">// License: https://creativecommons.org/licenses/by-nc-sa/4.0/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// See page 241.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Crawl2 crawls web links starting with the command-line arguments.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This version uses a buffered channel as a counting semaphore</span></span><br><span class="line"><span class="comment">// to limit the number of concurrent calls to links.Extract.</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"gopl.io/ch5/links"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//!+sema</span></span><br><span class="line"><span class="comment">// tokens is a counting semaphore used to</span></span><br><span class="line"><span class="comment">// enforce a limit of 20 concurrent requests.</span></span><br><span class="line"><span class="keyword">var</span> tokens = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">crawl</span><span class="params">(url <span class="keyword">string</span>, deepth <span class="keyword">int</span>, f *os.File)</span> <span class="title">work</span></span> &#123;</span><br><span class="line">	tokens &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">// acquire a token</span></span><br><span class="line">	list, err := links.Extract(url)</span><br><span class="line">	fmt.Fprintln(f, deepth, <span class="string">" "</span>, url, <span class="string">" "</span>, <span class="built_in">len</span>(list))</span><br><span class="line">	&lt;-tokens <span class="comment">// release the token</span></span><br><span class="line">	deepth++</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Print(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> work&#123;list, deepth&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-sema</span></span><br><span class="line"><span class="keyword">type</span> work <span class="keyword">struct</span> &#123;</span><br><span class="line">	worklist   []<span class="keyword">string</span></span><br><span class="line">	workdeepth <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> DEEPTH = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//!+</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	wkpool := <span class="built_in">make</span>(<span class="keyword">chan</span> work)</span><br><span class="line">	<span class="keyword">var</span> n <span class="keyword">int</span> <span class="comment">// number of pending sends to worklist</span></span><br><span class="line">	f, _ := os.Create(<span class="string">"stat"</span>)</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line">	<span class="comment">// Start with the command-line arguments.</span></span><br><span class="line">	n++</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; wkpool &lt;- work&#123;os.Args[<span class="number">1</span>:], <span class="number">0</span>&#125; &#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Crawl the web concurrently.</span></span><br><span class="line">	seen := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">for</span> ; n &gt; <span class="number">0</span>; n-- &#123;</span><br><span class="line">		wk := &lt;-wkpool</span><br><span class="line">		<span class="keyword">if</span> wk.workdeepth &gt; DEEPTH &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, link := <span class="keyword">range</span> wk.worklist &#123;</span><br><span class="line">			<span class="keyword">if</span> !seen[link] &#123;</span><br><span class="line">				seen[link] = <span class="literal">true</span></span><br><span class="line">				n++</span><br><span class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(link <span class="keyword">string</span>, deepth <span class="keyword">int</span>, f *os.File)</span></span> &#123;</span><br><span class="line">					wkpool &lt;- crawl(link, deepth, f)</span><br><span class="line">				&#125;(link, wk.workdeepth, f)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Ex-8-8"><a href="#Ex-8-8" class="headerlink" title="Ex 8.8"></a>Ex 8.8</h3><p>Using a select statement, add a timeout to the echo server from Section 8.3 so that it disconnects any client that shouts nothing within 10 seconds.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//client</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Ldate | log.Lmicroseconds)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!+</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f, err := os.Open(<span class="string">"a"</span>)</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line">	conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">"connected!"</span>)</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		io.Copy(os.Stdout, conn) <span class="comment">// <span class="doctag">NOTE:</span> ignoring errors</span></span><br><span class="line">		log.Println(<span class="string">"done"</span>)</span><br><span class="line">		done &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; <span class="comment">// signal the main goroutine</span></span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		mustCopy(conn, os.Stdin)</span><br><span class="line">		<span class="comment">//conn.Close()</span></span><br><span class="line">		err = conn.(*net.TCPConn).CloseWrite() <span class="comment">//经实验：必须要关，否则无法通知服务端输入已结束（但不应该是服务端根据EOF来判断吗？）</span></span><br><span class="line">		log.Println(<span class="string">"write finished in client: "</span>, err)</span><br><span class="line">	&#125;()</span><br><span class="line">	&lt;-done <span class="comment">// wait for background goroutine to finish</span></span><br><span class="line">	log.Printf(<span class="string">"local in server: %#v\n"</span>, conn.LocalAddr())</span><br><span class="line">	log.Printf(<span class="string">"remote in server: %#v\n"</span>, conn.RemoteAddr())</span><br><span class="line">	log.Println(<span class="string">"finish print"</span>)</span><br><span class="line">	<span class="comment">//err = conn.(*net.TCPConn).CloseRead()</span></span><br><span class="line">	<span class="comment">//log.Println("read finished in client: ", err)</span></span><br><span class="line">	err = conn.Close()</span><br><span class="line">	log.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mustCopy</span><span class="params">(dst io.Writer, src io.Reader)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, err := io.Copy(dst, src); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server</span></span><br><span class="line"><span class="comment">// Copyright © 2016 Alan A. A. Donovan &amp; Brian W. Kernighan.</span></span><br><span class="line"><span class="comment">// License: https://creativecommons.org/licenses/by-nc-sa/4.0/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// See page 224.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Reverb2 is a TCP server that simulates an echo.</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Ldate | log.Lmicroseconds)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">echo</span><span class="params">(c net.Conn, shout <span class="keyword">string</span>, delay time.Duration, wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> wg.Done()</span><br><span class="line">	fmt.Fprintln(c, <span class="string">"\t"</span>, strings.ToUpper(shout))</span><br><span class="line">	time.Sleep(delay)</span><br><span class="line">	fmt.Fprintln(c, <span class="string">"\t"</span>, shout)</span><br><span class="line">	time.Sleep(delay)</span><br><span class="line">	fmt.Fprintln(c, <span class="string">"\t"</span>, strings.ToLower(shout))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!+</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line">	msg := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line">		<span class="comment">//for &#123;</span></span><br><span class="line">		input := bufio.NewScanner(c)</span><br><span class="line">		<span class="keyword">for</span> input.Scan() &#123;</span><br><span class="line">			fmt.Println(<span class="string">"getting: "</span>, input.Text())</span><br><span class="line">			msg &lt;- input.Text()</span><br><span class="line">		&#125;</span><br><span class="line">		msg &lt;- <span class="string">"eof"</span></span><br><span class="line">		<span class="comment">//&#125;</span></span><br><span class="line">	&#125;(c)</span><br><span class="line">	ticker := time.NewTicker(<span class="number">5</span> * time.Second)</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">label1:</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">			ticker.Stop()</span><br><span class="line">			c.Close()</span><br><span class="line">			fmt.Println(<span class="string">"connect closed!!"</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> s := &lt;-msg:</span><br><span class="line">			<span class="keyword">if</span> s == <span class="string">"eof"</span> &#123;</span><br><span class="line">				<span class="keyword">break</span> label1</span><br><span class="line">			&#125;</span><br><span class="line">			ticker.Stop()</span><br><span class="line">			fmt.Println(s)</span><br><span class="line">			wg.Add(<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">go</span> echo(c, s, <span class="number">1</span>*time.Second, &amp;wg)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> ignoring potential errors from input.Err()</span></span><br><span class="line">	<span class="comment">//err := c.(*net.TCPConn).CloseRead()</span></span><br><span class="line">	<span class="comment">//log.Println("read finished in server: ", err)</span></span><br><span class="line">	log.Println(<span class="string">"finish scan"</span>)</span><br><span class="line">	log.Printf(<span class="string">"local in server: %#v\n"</span>, c.LocalAddr())</span><br><span class="line">	log.Printf(<span class="string">"remote in server: %#v\n"</span>, c.RemoteAddr())</span><br><span class="line">	wg.Wait()</span><br><span class="line">	err := c.(*net.TCPConn).CloseWrite()</span><br><span class="line">	<span class="comment">//err := c.Close()</span></span><br><span class="line">	log.Println(<span class="string">"finished in server: "</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	l, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, err := l.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Print(err) <span class="comment">// e.g., connection aborted</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> handleConn(conn)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//client</span><br><span class="line">$ ./ex8.3</span><br><span class="line">2018/01/03 17:01:15.985187 connected!</span><br><span class="line">2018/01/03 17:01:20.989292 <span class="keyword">done</span></span><br><span class="line">2018/01/03 17:01:20.989515 <span class="built_in">local</span> <span class="keyword">in</span> server: &amp;net.TCPAddr&#123;IP:net.IP&#123;0x7f, 0x0, 0x0, 0x1&#125;, Port:49954, Zone:<span class="string">""</span>&#125;</span><br><span class="line">2018/01/03 17:01:20.989576 remote <span class="keyword">in</span> server: &amp;net.TCPAddr&#123;IP:net.IP&#123;0x7f, 0x0, 0x0, 0x1&#125;, Port:8000, Zone:<span class="string">""</span>&#125;</span><br><span class="line">2018/01/03 17:01:20.989596 finish <span class="built_in">print</span></span><br><span class="line">2018/01/03 17:01:20.989774 &lt;nil&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//server</span><br><span class="line">./ex8.8</span><br><span class="line">2018/01/03 17:01:20.989248 connect closed!! 127.0.0.1:8000 127.0.0.1:49954</span><br></pre></td></tr></table></figure>
<h3 id="Ex-8-9"><a href="#Ex-8-9" class="headerlink" title="Ex 8.9"></a>Ex 8.9</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright © 2016 Alan A. A. Donovan &amp; Brian W. Kernighan.</span></span><br><span class="line"><span class="comment">// License: https://creativecommons.org/licenses/by-nc-sa/4.0/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// See page 250.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The du3 command computes the disk usage of the files in a directory.</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// The du3 variant traverses all directories in parallel.</span></span><br><span class="line"><span class="comment">// It uses a concurrency-limiting counting semaphore</span></span><br><span class="line"><span class="comment">// to avoid opening too many files at once.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"path/filepath"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vFlag = flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"show verbose progress messages"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetFlags(log.Ldate | log.Lmicroseconds)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!+</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// ...determine roots...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//!-</span></span><br><span class="line">	flag.Parse()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine the initial directories.</span></span><br><span class="line">	roots := flag.Args()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(roots) == <span class="number">0</span> &#123;</span><br><span class="line">		roots = []<span class="keyword">string</span>&#123;<span class="string">"."</span>&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//!+</span></span><br><span class="line">	<span class="comment">// Traverse each root of the file tree in parallel.</span></span><br><span class="line">	<span class="comment">//fileSizes := make(chan int64)</span></span><br><span class="line">	<span class="keyword">var</span> m sync.WaitGroup</span><br><span class="line">	<span class="keyword">for</span> _, root := <span class="keyword">range</span> roots &#123;</span><br><span class="line">		<span class="keyword">var</span> tick &lt;-<span class="keyword">chan</span> time.Time</span><br><span class="line">		<span class="keyword">if</span> *vFlag &#123;</span><br><span class="line">			tick = time.Tick(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">var</span> fileSizes <span class="keyword">chan</span> <span class="keyword">int64</span></span><br><span class="line">		<span class="keyword">var</span> n sync.WaitGroup</span><br><span class="line">		fileSizes = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>)</span><br><span class="line">		n.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> walkDir(root, &amp;n, fileSizes)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			n.Wait()</span><br><span class="line">			<span class="built_in">close</span>(fileSizes)</span><br><span class="line">		&#125;()</span><br><span class="line">		m.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(root <span class="keyword">string</span>, tick &lt;-<span class="keyword">chan</span> time.Time)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> m.Done()</span><br><span class="line">			<span class="keyword">var</span> nfiles, nbytes <span class="keyword">int64</span></span><br><span class="line">		loop:</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> size, ok := &lt;-fileSizes:</span><br><span class="line">					<span class="keyword">if</span> !ok &#123;</span><br><span class="line">						<span class="keyword">break</span> loop <span class="comment">// fileSizes was closed</span></span><br><span class="line">					&#125;</span><br><span class="line">					nfiles++</span><br><span class="line">					nbytes += size</span><br><span class="line">				<span class="keyword">case</span> &lt;-tick:</span><br><span class="line">					printDiskUsage(root, nfiles, nbytes)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			printDiskUsage(root, nfiles, nbytes) <span class="comment">// final totals</span></span><br><span class="line">		&#125;(root, tick)</span><br><span class="line">	&#125;</span><br><span class="line">	m.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printDiskUsage</span><span class="params">(root <span class="keyword">string</span>, nfiles, nbytes <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"%s: %d files  %.1f GB\n"</span>, root, nfiles, <span class="keyword">float64</span>(nbytes)/<span class="number">1e9</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// walkDir recursively walks the file tree rooted at dir</span></span><br><span class="line"><span class="comment">// and sends the size of each found file on fileSizes.</span></span><br><span class="line"><span class="comment">//!+walkDir</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">walkDir</span><span class="params">(dir <span class="keyword">string</span>, n *sync.WaitGroup, fileSizes <span class="keyword">chan</span>&lt;- <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> n.Done()</span><br><span class="line">	<span class="keyword">for</span> _, entry := <span class="keyword">range</span> dirents(dir) &#123;</span><br><span class="line">		<span class="keyword">if</span> entry.IsDir() &#123;</span><br><span class="line">			n.Add(<span class="number">1</span>)</span><br><span class="line">			subdir := filepath.Join(dir, entry.Name())</span><br><span class="line">			<span class="keyword">go</span> walkDir(subdir, n, fileSizes)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fileSizes &lt;- entry.Size()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-walkDir</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//!+sema</span></span><br><span class="line"><span class="comment">// sema is a counting semaphore for limiting concurrency in dirents.</span></span><br><span class="line"><span class="keyword">var</span> sema = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// dirents returns the entries of directory dir.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dirents</span><span class="params">(dir <span class="keyword">string</span>)</span> []<span class="title">os</span>.<span class="title">FileInfo</span></span> &#123;</span><br><span class="line">	sema &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;        <span class="comment">// acquire token</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; &lt;-sema &#125;() <span class="comment">// release token</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">//!-sema</span></span><br><span class="line"></span><br><span class="line">	entries, err := ioutil.ReadDir(dir)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">//fmt.Fprintf(os.Stderr, "du: %v\n", err)</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> entries</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ./ex8.9 -v /etc /usr /bin /var</span><br><span class="line">2018/01/03 20:36:21.368337 /bin: 36 files  0.0 GB</span><br><span class="line">2018/01/03 20:36:21.370797 /etc: 308 files  0.0 GB</span><br><span class="line">2018/01/03 20:36:21.483464 /var: 2270 files  6.1 GB</span><br><span class="line">2018/01/03 20:36:21.483846 /usr: 4322 files  1.9 GB</span><br><span class="line">2018/01/03 20:36:21.571401 /var: 2449 files  6.3 GB</span><br><span class="line">2018/01/03 20:36:21.599092 /usr: 9322 files  2.1 GB</span><br><span class="line">2018/01/03 20:36:21.678850 /usr: 18130 files  2.6 GB</span><br><span class="line">2018/01/03 20:36:21.782177 /usr: 47807 files  3.2 GB</span><br><span class="line">2018/01/03 20:36:21.872339 /usr: 65859 files  3.7 GB</span><br><span class="line">2018/01/03 20:36:21.920744 /usr: 89008 files  3.9 GB</span><br></pre></td></tr></table></figure>
<h3 id="Ex-8-12"><a href="#Ex-8-12" class="headerlink" title="Ex 8.12"></a>Ex 8.12</h3><p>Make the broadcaster announce the current set of clients to each new arrival. This requires that the clients set and the entering and leaving channels record the client name too.</p>
<h3 id="Ex-8-13"><a href="#Ex-8-13" class="headerlink" title="Ex 8.13"></a>Ex 8.13</h3><p>Make the chat server disconnect idle clients, such as those that have sent no messages in the last ﬁve minutes. Hint: calling conn.Close() in another goroutine unblocks active Read calls such as the one done by input.Scan().</p>
<h3 id="Ex-8-14"><a href="#Ex-8-14" class="headerlink" title="Ex 8.14"></a>Ex 8.14</h3><p>Change the chat server’s network protocol so that each client provides its name on entering. Use that name instead of the network address when preﬁxing each message with its sender’s identity.</p>
<p>只需要添加自定义协议，在压包解包的时候按协议进行就行，待做。。。</p>
<h3 id="Ex-8-15"><a href="#Ex-8-15" class="headerlink" title="Ex 8.15"></a>Ex 8.15</h3><p>Failure of any client program to read data in a timely manner ultimately causes all clients to get stuck. Modify the broadcaster to skip a message rather than wait if a client writer is not ready to accept it. Alternatively, add buffering to each client’s outgoing message channel so that most messages are not dropped; the broadcaster should use a non-blocking send to this channel.</p>
<p>将broadcaster中向各个客户端发送消息的部分写入go routine，并将客户端发送通道定义为缓存通道</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright © 2016 Alan A. A. Donovan &amp; Brian W. Kernighan.</span></span><br><span class="line"><span class="comment">// License: https://creativecommons.org/licenses/by-nc-sa/4.0/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// See page 254.</span></span><br><span class="line"><span class="comment">//!+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Chat is a server that lets clients chat with each other.</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bufio"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//!+broadcaster</span></span><br><span class="line"><span class="keyword">type</span> client <span class="keyword">chan</span>&lt;- <span class="keyword">string</span> <span class="comment">// an outgoing message channel</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	entering = <span class="built_in">make</span>(<span class="keyword">chan</span> client)</span><br><span class="line">	leaving  = <span class="built_in">make</span>(<span class="keyword">chan</span> client)</span><br><span class="line">	messages = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>) <span class="comment">// all incoming client messages</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">broadcaster</span><span class="params">()</span></span> &#123;</span><br><span class="line">	clients := <span class="built_in">make</span>(<span class="keyword">map</span>[client]<span class="keyword">bool</span>) <span class="comment">// all connected clients</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> msg := &lt;-messages:</span><br><span class="line">			<span class="comment">// Broadcast incoming message to all</span></span><br><span class="line">			<span class="comment">// clients' outgoing message channels.</span></span><br><span class="line">			<span class="keyword">for</span> cli := <span class="keyword">range</span> clients &#123;</span><br><span class="line">				cli &lt;- msg</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> cli := &lt;-entering:</span><br><span class="line">			clients[cli] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> cli := &lt;-leaving:</span><br><span class="line">			<span class="built_in">delete</span>(clients, cli)</span><br><span class="line">			<span class="built_in">close</span>(cli)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-broadcaster</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//!+handleConn</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConn</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">	inittime := time.Now()</span><br><span class="line">	itimestr := <span class="string">"["</span> + inittime.Format(<span class="string">"2006-01-02 15:04:05"</span>) + <span class="string">"]"</span></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>) <span class="comment">// outgoing client messages</span></span><br><span class="line">	<span class="keyword">go</span> clientWriter(conn, ch)</span><br><span class="line">	lastmsgtime := <span class="built_in">make</span>(<span class="keyword">chan</span> time.Time)</span><br><span class="line">	who := conn.RemoteAddr().String()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(t time.Time)</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> t = &lt;-lastmsgtime:</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> time.Now().After(t.Add(<span class="number">20</span> * time.Second)) &#123;</span><br><span class="line">				ch &lt;- fmt.Sprintf(<span class="string">"[%s] no msg in last 20 sec since %s, closing connect!"</span>, time.Now().Format(<span class="string">"2006-01-02 15:04:05"</span>), t.Format(<span class="string">"2006-01-02 15:04:05"</span>))</span><br><span class="line">				time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">				conn.Close()</span><br><span class="line">				<span class="comment">//leaving &lt;- ch</span></span><br><span class="line">				<span class="comment">//messages &lt;- who + " has left"</span></span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(inittime)</span><br><span class="line">	ch &lt;- itimestr + <span class="string">" "</span> + <span class="string">"You are "</span> + who</span><br><span class="line">	messages &lt;- itimestr + <span class="string">" "</span> + who + <span class="string">" has arrived"</span></span><br><span class="line">	entering &lt;- ch</span><br><span class="line"></span><br><span class="line">	input := bufio.NewScanner(conn)</span><br><span class="line">	<span class="keyword">for</span> input.Scan() &#123;</span><br><span class="line">		messages &lt;- <span class="string">"["</span> + time.Now().Format(<span class="string">"2006-01-02 15:04:05"</span>) + <span class="string">"]"</span> + <span class="string">" "</span> + who + <span class="string">": "</span> + input.Text()</span><br><span class="line">		lastmsgtime &lt;- time.Now()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> ignoring potential errors from input.Err()</span></span><br><span class="line"></span><br><span class="line">	leaving &lt;- ch</span><br><span class="line">	messages &lt;- <span class="string">"["</span> + time.Now().Format(<span class="string">"2006-01-02 15:04:05"</span>) + <span class="string">"]"</span> + <span class="string">" "</span> + who + <span class="string">" has left"</span></span><br><span class="line">	conn.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">clientWriter</span><span class="params">(conn net.Conn, ch &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> msg := <span class="keyword">range</span> ch &#123;</span><br><span class="line">		fmt.Fprintln(conn, msg) <span class="comment">// <span class="doctag">NOTE:</span> ignoring network errors</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//!-handleConn</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//!+main</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> broadcaster()</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, err := listener.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Print(err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> handleConn(conn)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ ./netcat1</span><br><span class="line">[2018-01-04 01:09:14] You are 127.0.0.1:55627</span><br><span class="line">[2018-01-04 01:09:18] 127.0.0.1:55630 has arrived</span><br><span class="line">[2018-01-04 01:09:20] 127.0.0.1:55630: sdf</span><br><span class="line">[2018-01-04 01:09:24] 127.0.0.1:55635 has arrived</span><br><span class="line">[2018-01-04 01:09:28] 127.0.0.1:55635: ththth</span><br><span class="line">[2018-01-04 01:09:34] no msg <span class="keyword">in</span> last 20 sec since 2018-01-04 01:09:14, closing connect!</span><br><span class="line">2018/01/04 01:09:35 <span class="keyword">done</span></span><br><span class="line">$ ./netcat2</span><br><span class="line">[2018-01-04 01:09:18] You are 127.0.0.1:55630</span><br><span class="line">sdf</span><br><span class="line">[2018-01-04 01:09:20] 127.0.0.1:55630: sdf</span><br><span class="line">[2018-01-04 01:09:24] 127.0.0.1:55635 has arrived</span><br><span class="line">[2018-01-04 01:09:28] 127.0.0.1:55635: ththth</span><br><span class="line">[2018-01-04 01:09:35] 127.0.0.1:55627 has left</span><br><span class="line">[2018-01-04 01:09:40] no msg <span class="keyword">in</span> last 20 sec since 2018-01-04 01:09:20, closing connect!</span><br><span class="line">2018/01/04 01:09:41 <span class="keyword">done</span></span><br><span class="line">$ ./netcat3</span><br><span class="line">[2018-01-04 01:09:24] You are 127.0.0.1:55635</span><br><span class="line">ththth</span><br><span class="line">[2018-01-04 01:09:28] 127.0.0.1:55635: ththth</span><br><span class="line">[2018-01-04 01:09:35] 127.0.0.1:55627 has left</span><br><span class="line">[2018-01-04 01:09:41] 127.0.0.1:55630 has left</span><br><span class="line">[2018-01-04 01:09:48] no msg <span class="keyword">in</span> last 20 sec since 2018-01-04 01:09:28, closing connect!</span><br><span class="line">2018/01/04 01:09:49 <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

      
      
  <div class="article-statement">
    <hr>  
    1.如果本文帮到了您，不妨点一下右下角的 <a>分享到</a> 按钮。<br>
    2.除非注明，本博文章均为原创，转载请以链接形式标明本文地址。<br>
  </div>

    </div>
    <footer class="article-footer">
      
        <a data-url="https://mooncaker816.github.io/2018/01/03/The-Go-Programming-Language-Ex (10)/" data-id="cjg8zbbh2000e21w5oeg14z8o" class="article-share-link" data-share="baidu" data-title="The Go Programming Language Ex（10）">分享到</a>
      

      
      
        <a href="/2018/01/03/The-Go-Programming-Language-Ex (10)/#comments" class="article-comment-link">
          <span class="post-comments-count valine-comment-count" data-xid="/2018/01/03/The-Go-Programming-Language-Ex (10)/" itemprop="commentCount"></span>
          文章评论
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go-breadth-first-crawler/">Go breadth first crawler</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go-chat-room/">Go chat room</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go-goroutine/">Go goroutine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go-select/">Go select</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/The-Go-Programming-Language-Ex/">The Go Programming Language Ex</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/04/The-Go-Programming-Language-Ex (11)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          The Go Programming Language Ex（11）
        
      </div>
    </a>
  
  
    <a href="/2018/01/01/The-Go-Programming-Language-Ex (9)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">The Go Programming Language Ex（9）</div>
    </a>
  
</nav>

  
</article>



  <section id="comments" class="vcomment">
  </section>

</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bytes/">Bytes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/">Centos</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-BitMap/">Go BitMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-Func/">Go Func</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-In-Action/">Go In Action</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-Interface/">Go Interface</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-JSON/">Go JSON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-Method/">Go Method</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-Scanner/">Go Scanner</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-TCP-Conn/">Go TCP Conn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-array/">Go array</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-breadth-first-crawler/">Go breadth first crawler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-cache-store/">Go cache store</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-chat-room/">Go chat room</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-crawler/">Go crawler</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-goroutine/">Go goroutine</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-interface/">Go interface</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-map/">Go map</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-method/">Go method</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-package/">Go package</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-select/">Go select</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-slice/">Go slice</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-template/">Go template</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-type/">Go type</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go-标准库/">Go 标准库</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Strings/">Strings</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/The-Go-Programming-Language-Ex/">The Go Programming Language Ex</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/">npm</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Bytes/" style="font-size: 10px;">Bytes</a> <a href="/tags/Centos/" style="font-size: 12.5px;">Centos</a> <a href="/tags/Go-BitMap/" style="font-size: 10px;">Go BitMap</a> <a href="/tags/Go-Func/" style="font-size: 10px;">Go Func</a> <a href="/tags/Go-In-Action/" style="font-size: 17.5px;">Go In Action</a> <a href="/tags/Go-Interface/" style="font-size: 10px;">Go Interface</a> <a href="/tags/Go-JSON/" style="font-size: 10px;">Go JSON</a> <a href="/tags/Go-Method/" style="font-size: 10px;">Go Method</a> <a href="/tags/Go-Scanner/" style="font-size: 10px;">Go Scanner</a> <a href="/tags/Go-TCP-Conn/" style="font-size: 10px;">Go TCP Conn</a> <a href="/tags/Go-array/" style="font-size: 10px;">Go array</a> <a href="/tags/Go-breadth-first-crawler/" style="font-size: 10px;">Go breadth first crawler</a> <a href="/tags/Go-cache-store/" style="font-size: 10px;">Go cache store</a> <a href="/tags/Go-chat-room/" style="font-size: 10px;">Go chat room</a> <a href="/tags/Go-crawler/" style="font-size: 10px;">Go crawler</a> <a href="/tags/Go-goroutine/" style="font-size: 15px;">Go goroutine</a> <a href="/tags/Go-interface/" style="font-size: 10px;">Go interface</a> <a href="/tags/Go-map/" style="font-size: 12.5px;">Go map</a> <a href="/tags/Go-method/" style="font-size: 10px;">Go method</a> <a href="/tags/Go-package/" style="font-size: 10px;">Go package</a> <a href="/tags/Go-select/" style="font-size: 10px;">Go select</a> <a href="/tags/Go-slice/" style="font-size: 12.5px;">Go slice</a> <a href="/tags/Go-template/" style="font-size: 10px;">Go template</a> <a href="/tags/Go-type/" style="font-size: 10px;">Go type</a> <a href="/tags/Go-标准库/" style="font-size: 10px;">Go 标准库</a> <a href="/tags/Strings/" style="font-size: 10px;">Strings</a> <a href="/tags/The-Go-Programming-Language-Ex/" style="font-size: 20px;">The Go Programming Language Ex</a> <a href="/tags/npm/" style="font-size: 10px;">npm</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/21/Linux Centos 命令之 mkdir,rmdir,pwd,cd/">Linux Centos 命令之 mkdir,rmdir,pwd,cd</a>
          </li>
        
          <li>
            <a href="/2018/04/21/Linux Centos 命令之 ls/">Linux Centos 命令之 ls</a>
          </li>
        
          <li>
            <a href="/2018/01/14/strings & bytes/">Go 标准库学习</a>
          </li>
        
          <li>
            <a href="/2018/01/04/The-Go-Programming-Language-Ex (11)/">The Go Programming Language Ex（11）</a>
          </li>
        
          <li>
            <a href="/2018/01/03/The-Go-Programming-Language-Ex (10)/">The Go Programming Language Ex（10）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="https://github.com/mooncaker816" target="_blank">我的github</a>
          </li>
        
          <li>
            <a href="https://coding.net/u/mooncaker816" target="_blank">我的coding</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Mingle<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a><br/>
      <span id="busuanzi_container_site_pv">
        总访问量 <a href="http://service.ibruce.info/" target="_blank"><span id="busuanzi_value_site_pv"></span></a> 次
      </span>
      <span id="busuanzi_container_site_uv">
        <a href="http://service.ibruce.info/" target="_blank"><span id="busuanzi_value_site_uv"></span></a> 人.
      </span>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">主页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>


  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
        return GUEST_INFO.indexOf(item) > -1
    });
    var notify = 'false' == true;
    var verify = 'false' == true;
    new Valine({
        el: '.vcomment',
        notify: notify,
        verify: verify,
        appId: "urzxMG6IH6XwD3AIW0VH4lMb-gzGzoHsz",
        appKey: "WPbRVjy6oFOvnxYJJx9uTRR9",
        placeholder: "来侃一侃~",
        pageSize:'10',
        avatar:'identicon',
        lang:'zh-cn'
    });
</script>


</div>
</body>
</html>
